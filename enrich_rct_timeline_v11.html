<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EnRICH — 2025 Study & RCT Timeline v11</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Source+Serif+4:opsz,wght@8..60,400;8..60,600;8..60,700&family=DM+Sans:wght@400;500;600;700&display=swap');

  /* ── Okabe-Ito / Wong colorblind-safe palette ── */
  :root {
    --bg: #f6f4f0;
    --surface: #ffffff;
    --border: #d4d0c8;
    --text: #2c2a26;
    --text-muted: #6b6860;

    /* Intervention family — BLUE */
    --accent-rct: #0072B2;          /* bold blue — RCT intervention */
    --accent-2025: #56B4E9;         /* sky blue — 2025 intervention */

    /* Control family — GREY */
    --accent-ctrl: #888888;         /* mid grey — active control */
    --accent-ctrl-post: #AAAAAA;    /* lighter grey — residual controls */
    --accent-pre: #C0C0C0;         /* light grey — pre-intervention period */

    /* Data not analysed */
    --accent-nodata: #D9E8F5;       /* very pale blue wash */

    /* Regulatory & governance */
    --accent-reg: #D55E00;          /* vermillion */
    --accent-peer: #E69F00;         /* amber */

    /* Preparation */
    --accent-prep: #56707E;         /* slate */

    /* Data windows */
    --accent-data-trend: #009E73;   /* teal / bluish green */
    --accent-data-level: #CC79A7;   /* reddish purple */

    /* Analysis */
    --accent-obs: #E69F00;          /* amber (shared with peer but different context) */

    /* Drain badges */
    --accent-drain: #D55E00;

    /* Today line */
    --today: #882255;               /* wine / dark magenta — distinct from all bars */

    /* Milestones */
    --milestone: #2c2a26;

    --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
    --shadow-lg: 0 4px 12px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
    padding: 2rem;
  }

  .header {
    max-width: 1400px;
    margin: 0 auto 1.5rem;
    border-bottom: 3px solid var(--text);
    padding-bottom: 1rem;
  }

  .header h1 {
    font-family: 'Source Serif 4', serif;
    font-size: 1.8rem;
    font-weight: 700;
    letter-spacing: -0.02em;
  }

  .header .subtitle {
    font-size: 0.92rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
  }

  .legend-bar {
    margin-left: 260px;
    margin-bottom: 0.4rem;
    display: flex;
    flex-wrap: wrap;
    gap: 1.15rem;
    align-items: center;
    font-size: 0.72rem;
    color: var(--text-muted);
  }

  .legend-item { display: flex; align-items: center; gap: 0.35rem; }
  .legend-swatch { width: 16px; height: 9px; border-radius: 2px; flex-shrink: 0; }

  .chart-container {
    max-width: 1400px;
    margin: 0 auto;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    box-shadow: var(--shadow-lg);
    padding: 1.5rem 1rem 1rem;
  }

  .chart-wrapper { position: relative; min-width: 1100px; }

  .month-header {
    display: flex;
    margin-left: 260px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 0.35rem;
    margin-bottom: 0.4rem;
  }

  .month-cell {
    flex: 1;
    text-align: center;
    font-size: 0.68rem;
    font-weight: 600;
    color: var(--text-muted);
  }

  .month-cell.year-start { font-weight: 700; color: var(--text); }

  .sticky-header {
    position: sticky;
    top: 0;
    background: var(--surface);
    z-index: 10;
    padding-top: 0.5rem;
    box-shadow: none;
    transition: box-shadow 0.15s;
  }

  .year-label { display: flex; margin-left: 260px; margin-bottom: 0.1rem; }

  .year-span {
    text-align: center;
    font-size: 0.82rem;
    font-weight: 700;
    font-family: 'Source Serif 4', serif;
    color: var(--text);
    border-bottom: 2px solid var(--text);
    padding-bottom: 0.1rem;
    margin-bottom: 0.15rem;
  }

  .section-label {
    font-family: 'Source Serif 4', serif;
    font-size: 0.82rem;
    font-weight: 700;
    padding: 0.55rem 0 0.2rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    border-top: 1px solid var(--border);
    margin-top: 0.35rem;
  }

  .section-label:first-of-type { border-top: none; margin-top: 0; }

  .row { display: flex; align-items: center; position: relative; }
  .row.row-thin { height: 20px; }
  .row.row-thick { height: 30px; }
  .row.row-std { height: 25px; }

  .row-label {
    width: 260px;
    flex-shrink: 0;
    font-size: 0.73rem;
    font-weight: 500;
    padding-right: 0.75rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .row-label .count {
    display: inline-block;
    background: #e8e6e0;
    color: var(--text-muted);
    font-size: 0.62rem;
    font-weight: 700;
    padding: 0px 5px;
    border-radius: 3px;
    margin-left: 4px;
    vertical-align: middle;
  }

  .row-label .count-drain {
    display: inline-block;
    background: #fde8df;
    color: var(--accent-drain);
    font-size: 0.60rem;
    font-weight: 700;
    padding: 0px 4px;
    border-radius: 3px;
    margin-left: 3px;
    vertical-align: middle;
  }

  .row-label .go-live-date {
    font-size: 0.62rem;
    color: var(--text-muted);
    font-weight: 400;
    margin-left: 2px;
  }

  .row-track { flex: 1; position: relative; height: 100%; }

  /* Thin bars — 2025 study */
  .bar-thin {
    position: absolute;
    height: 10px;
    border-radius: 2px;
    cursor: default;
    transition: opacity 0.15s;
    z-index: 2;
  }
  .row-thin .bar-thin { top: 5px; }
  .bar-thin:hover { opacity: 0.8; box-shadow: var(--shadow); }

  /* Thick bars — RCT */
  .bar-thick {
    position: absolute;
    height: 20px;
    border-radius: 3px;
    font-size: 0.62rem;
    font-weight: 600;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    white-space: nowrap;
    cursor: default;
    transition: opacity 0.15s;
    z-index: 2;
  }
  .row-thick .bar-thick { top: 5px; }
  .bar-thick:hover { opacity: 0.82; box-shadow: var(--shadow); }

  /* Standard bars — regulatory etc */
  .bar {
    position: absolute;
    height: 15px;
    top: 5px;
    border-radius: 3px;
    cursor: default;
    transition: opacity 0.15s;
    z-index: 2;
  }
  .bar:hover { opacity: 0.82; box-shadow: var(--shadow); }

  .bg-reg { background: var(--accent-reg); }
  .bg-peer { background: var(--accent-peer); }
  .bg-rct { background: var(--accent-rct); }
  .bg-ctrl { background: var(--accent-ctrl); }
  .bg-ctrl-post { background: var(--accent-ctrl-post); }
  .bg-pre { background: var(--accent-pre); }
  .bg-2025 { background: var(--accent-2025); }
  .bg-nodata { background: var(--accent-nodata); }
  .bg-prep { background: var(--accent-prep); }
  .bg-data-trend { background: var(--accent-data-trend); opacity: 0.65; }
  .bg-data-level { background: var(--accent-data-level); opacity: 0.65; }
  .bg-obs { background: var(--accent-obs); opacity: 0.6; }

  /* Data window bars */
  .bar-data {
    position: absolute;
    height: 9px;
    border-radius: 2px;
    cursor: default;
    transition: opacity 0.15s;
    z-index: 2;
  }
  .bar-data:hover { opacity: 0.8; }

  /* Dashed leader — extends before visible timeline */
  .bar-dashed-leader {
    position: absolute;
    height: 10px;
    border-radius: 2px 0 0 2px;
    z-index: 1;
    cursor: default;
    background: repeating-linear-gradient(90deg, var(--accent-ctrl) 0px, var(--accent-ctrl) 5px, transparent 5px, transparent 9px);
  }
  .row-thin .bar-dashed-leader { top: 5px; }

  .bar-dashed-leader-pre {
    background: repeating-linear-gradient(90deg, var(--accent-pre) 0px, var(--accent-pre) 5px, transparent 5px, transparent 9px);
  }

  .pre-arrow {
    position: absolute;
    font-size: 0.55rem;
    font-weight: 600;
    top: 4px;
    z-index: 4;
    white-space: nowrap;
    pointer-events: none;
  }
  .pre-arrow.clr-ctrl { color: var(--accent-ctrl); }
  .pre-arrow.clr-pre { color: var(--accent-pre); }

  .milestone-diamond {
    position: absolute;
    width: 9px;
    height: 9px;
    background: var(--milestone);
    transform: rotate(45deg);
    z-index: 3;
    cursor: default;
  }
  .row-thin .milestone-diamond { top: 5.5px; }
  .row-thick .milestone-diamond { top: 10.5px; }
  .row-std .milestone-diamond { top: 8px; }
  .row:not(.row-thin):not(.row-thick):not(.row-std) .milestone-diamond { top: 8px; }

  .milestone-diamond.red { background: var(--accent-reg); }
  .milestone-diamond.blue { background: var(--accent-rct); }

  .go-live-tick {
    position: absolute;
    width: 0;
    border-left: 1.5px solid rgba(0,114,178,0.6);
    z-index: 4;
    pointer-events: none;
  }
  .row-thin .go-live-tick { height: 14px; top: 3px; }

  .today-line {
    position: absolute;
    top: 0; bottom: 0; width: 0;
    border-left: 2.5px dashed var(--today);
    z-index: 5;
    pointer-events: none;
  }

  .today-flag {
    position: absolute;
    transform: translateX(-50%);
    background: var(--today);
    color: #fff;
    font-size: 0.58rem;
    font-weight: 700;
    padding: 1px 5px;
    border-radius: 2px;
    white-space: nowrap;
    z-index: 6;
  }

  .tooltip {
    display: none;
    position: fixed;
    background: var(--text);
    color: #fff;
    font-size: 0.72rem;
    padding: 0.4rem 0.65rem;
    border-radius: 4px;
    max-width: 380px;
    z-index: 100;
    pointer-events: none;
    line-height: 1.4;
    box-shadow: var(--shadow-lg);
  }

  .notes {
    max-width: 1400px;
    margin: 1.5rem auto 0;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .note-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 1rem 1.25rem;
    box-shadow: var(--shadow);
  }

  .note-card h3 {
    font-family: 'Source Serif 4', serif;
    font-size: 0.88rem;
    font-weight: 700;
    margin-bottom: 0.4rem;
  }

  .note-card p, .note-card li { font-size: 0.77rem; color: var(--text-muted); line-height: 1.55; }
  .note-card ul, .note-card ol { padding-left: 1.1rem; margin-top: 0.25rem; }
  .note-card li { margin-bottom: 0.2rem; }
  .note-card .role-note { font-size: 0.72rem; color: var(--accent-reg); font-style: italic; margin-left: 0.3rem; }
  .note-card .footnote { margin-top: 0.7rem; padding-top: 0.5rem; border-top: 1px solid var(--border); font-size: 0.72rem; color: var(--accent-reg); font-weight: 600; }

  .wave-table { width: 100%; border-collapse: collapse; font-size: 0.73rem; margin-top: 0.4rem; }
  .wave-table th { text-align: left; font-weight: 600; padding: 0.25rem 0.4rem; border-bottom: 2px solid var(--border); }
  .wave-table td { padding: 0.25rem 0.4rem; border-bottom: 1px solid #eee; color: var(--text-muted); }

  @media (max-width: 900px) { .notes { grid-template-columns: 1fr; } body { padding: 1rem; } }
</style>
</head>
<body>

<div class="header">
  <h1>EnRICH &mdash; 2025 Study &amp; RCT Regulatory &amp; Rollout Timeline</h1>
  <div class="subtitle">2025 quasi-experimental study (11 + 22 controls) &amp; phased cluster RCT (14 pairs, 28 homes, 3 waves) &middot; Generated <span id="gen-date"></span></div>
</div>

<div class="chart-container">
  <div class="chart-wrapper" id="chart"></div>
</div>

<div id="tooltip" class="tooltip"></div>

<div class="notes">
  <div class="note-card">
    <h3>Regulatory &amp; Approval Pathway</h3>
    <p>Working backwards from May 2026 Wave 1 start:</p>
    <ul>
      <li><strong>Protocol finalisation + peer review:</strong> ~5 weeks (mid Feb &ndash; late Mar 2026)</li>
      <li><strong>IRAS form preparation:</strong> ~2 weeks (late Mar &ndash; mid Apr)</li>
      <li><strong>REC review:</strong> Statutory 60 calendar days &mdash; rate-limiting step</li>
      <li><strong>CAG application:</strong> Parallel; ~40 working days</li>
      <li><strong>ISRCTN registration:</strong> Alongside IRAS; ~2&ndash;4 weeks</li>
    </ul>
    <p style="margin-top:0.5rem;">REC approval likely lands mid-June at earliest. Wave 1 in May requires either service evaluation classification or conditional start pending approval.</p>
  </div>

  <div class="note-card">
    <h3>Wave Schedule &amp; Data Windows (v7)</h3>
    <table class="wave-table">
      <thead><tr><th>Wave</th><th>Start</th><th>Pairs</th><th>Homes</th><th>Trend Window</th><th>Level Window</th></tr></thead>
      <tbody>
        <tr><td>1</td><td>May 2026</td><td>5</td><td>10</td><td>1 Mar 2024 &ndash; 28 Feb 2026</td><td>1 Mar 2025 &ndash; 28 Feb 2026</td></tr>
        <tr><td>2</td><td>Sep 2026</td><td>5</td><td>10</td><td>1 Jul 2024 &ndash; 30 Jun 2026</td><td>1 Jul 2025 &ndash; 30 Jun 2026</td></tr>
        <tr><td>3</td><td>Jan 2027</td><td>4</td><td>8</td><td>1 Nov 2024 &ndash; 31 Oct 2026</td><td>1 Nov 2025 &ndash; 31 Oct 2026</td></tr>
      </tbody>
    </table>
    <p style="margin-top:0.5rem;">W1 data already closed. Primary analysis &ge; <strong>Jul 2028</strong>. Of the 22 original controls, 14 enter the RCT across waves, leaving 8 as pure observational controls.</p>
  </div>

  <div class="note-card">
    <h3>Key Personnel Requiring Funding</h3>
    <ol>
      <li>Oversight &mdash; Ethics and Ageing &mdash; <strong>Professor</strong></li>
      <li>Oversight &mdash; Geriatrics &mdash; <strong>Professor</strong></li>
      <li>Chief Investigator &mdash; <strong>Quantitative</strong></li>
      <li>Principal Investigator &mdash; <strong>Qualitative</strong></li>
      <li>Statistician <span class="role-note">&mdash; Req: access to CUH network</span></li>
      <li>Administration &mdash; <strong>Band 3&ndash;4 AfC</strong></li>
      <li>Trust R&amp;D Project Manager</li>
    </ol>
    <div class="footnote">Note: R&amp;D overheads of 20% should be factored into any grant funding applications.</div>
  </div>

  <div class="note-card">
    <h3>Key Dependencies &amp; Risks</h3>
    <ul>
      <li><strong>Critical path:</strong> Peer review &rarr; Protocol lock &rarr; IRAS &rarr; REC &rarr; Wave 1</li>
      <li><strong>Parallel:</strong> CAG + ISRCTN alongside REC; W1 data extraction runs now</li>
      <li><strong>Risk &mdash; REC queries:</strong> +4&ndash;6 weeks &rarr; W1 slips to ~Jul 2026</li>
      <li><strong>Risk &mdash; Peer review:</strong> &gt;3 weeks &rarr; compress IRAS prep or accept delay</li>
      <li><strong>W1 data closed:</strong> Trend &amp; level end Feb 2026 &mdash; extract now</li>
      <li><strong>Workforce clause:</strong> Protocol allows wave delays; preserves 18-mo minimum</li>
      <li><strong>Control pool drain:</strong> 14 of 22 original controls enter RCT; 8 remain as pure observational controls throughout</li>
    </ul>
  </div>
</div>

<script>
const TIMELINE_START = new Date(2024, 5, 1);
const TIMELINE_END   = new Date(2029, 0, 31);
const TODAY = new Date();
const STUDY_END = new Date(2028, 6, 1);
const END_2025 = new Date(2025, 11, 31);
const PRE_INT_START = new Date(2023, 0, 1); // panel starts Jan 2023
const W1_START = new Date(2026, 4, 1);
const W2_START = new Date(2026, 8, 1);
const W3_START = new Date(2027, 0, 1);
const LEADER_W = 2.5;

const totalDays = (TIMELINE_END - TIMELINE_START) / 864e5;
function pct(date) { return Math.max(0, Math.min(100, ((date - TIMELINE_START) / 864e5) / totalDays * 100)); }

const mFull = ['January','February','March','April','May','June','July','August','September','October','November','December'];
document.getElementById('gen-date').textContent = TODAY.getDate() + ' ' + mFull[TODAY.getMonth()] + ' ' + TODAY.getFullYear();

const goLive = [
  { id: '10A', date: new Date(2024,9,3),  lbl: '3 Oct 2024' },
  { id: '5A',  date: new Date(2024,9,4),  lbl: '4 Oct 2024' },
  { id: '3A',  date: new Date(2025,1,28), lbl: '28 Feb 2025' },
  { id: '9A',  date: new Date(2025,2,4),  lbl: '4 Mar 2025' },
  { id: '4A',  date: new Date(2025,2,5),  lbl: '5 Mar 2025' },
  { id: '2A',  date: new Date(2025,2,26), lbl: '26 Mar 2025' },
  { id: '1A',  date: new Date(2025,3,10), lbl: '10 Apr 2025' },
  { id: '11A', date: new Date(2025,5,10), lbl: '10 Jun 2025' },
  { id: '6A',  date: new Date(2025,8,16), lbl: '16 Sep 2025' },
  { id: '7A',  date: new Date(2025,8,16), lbl: '16 Sep 2025' },
  { id: '8A',  date: new Date(2025,9,21), lbl: '21 Oct 2025' },
];

// Intervention home rows with grey pre-intervention + blue active + pale nodata
function makeIntRows() {
  return goLive.map(h => {
    const preBeforeTimeline = true; // all homes have panel data from Jan 2023
    const goLiveBeforeTimeline = h.date < TIMELINE_START;
    const visGoLive = goLiveBeforeTimeline ? TIMELINE_START : h.date;

    const bars = [];

    // Grey pre-intervention bar (Jan 2023 → go-live)
    // Visible portion: timeline start → go-live (or nothing if go-live is before timeline)
    if (!goLiveBeforeTimeline) {
      bars.push({
        start: TIMELINE_START, end: h.date, cls: 'bg-pre',
        tip: 'Home ' + h.id + ': pre-intervention usual care (Jan 2023 \u2013 ' + h.lbl + ')',
        dashedJoin: false
      });
    }

    // Blue active intervention bar (go-live → Dec 2025)
    bars.push({
      start: visGoLive, end: END_2025, cls: 'bg-2025',
      tip: 'Home ' + h.id + ': EnRICH active ' + h.lbl + ' \u2013 31 Dec 2025 (analysed)',
      dashedJoin: goLiveBeforeTimeline
    });

    // Pale nodata bar (Jan 2026 → Jul 2028)
    bars.push({
      start: new Date(2026,0,1), end: STUDY_END, cls: 'bg-nodata',
      tip: 'Home ' + h.id + ': data not analysed (Jan 2026 \u2013 Jul 2028)'
    });

    return {
      labelHtml: 'Home ' + h.id + ' <span class="go-live-date">' + h.lbl + '</span>',
      thin: true,
      // All homes get a dashed leader (pre-intervention extends to Jan 2023)
      dashed: true,
      dashedCls: 'bar-dashed-leader-pre',
      dashedArrowCls: 'clr-pre',
      dashedTip: 'Pre-intervention panel data from Jan 2023' + (goLiveBeforeTimeline ? '; go-live: ' + h.lbl : ''),
      goLiveTick: !goLiveBeforeTimeline ? h.date : null,
      bars: bars
    };
  });
}

// Control pool rows
function makeCtrlRows() {
  return [
    {
      labelHtml: '2025 controls <span class="count">22 homes</span>',
      thin: true,
      dashed: true, dashedCls: '', dashedArrowCls: 'clr-ctrl',
      dashedTip: 'Control observation extends back to Jan 2023',
      bars: [
        { start: TIMELINE_START, end: W1_START, cls: 'bg-ctrl', tip: '22 matched control homes: usual care Jan 2023 \u2013 Apr 2026 (full pool before RCT)' },
      ]
    },
    {
      labelHtml: 'Remaining controls <span class="count">17</span> <span class="count-drain">\u22125 \u2192 RCT W1</span>',
      thin: true,
      bars: [
        { start: W1_START, end: W2_START, cls: 'bg-ctrl', tip: '17 controls remaining: 5 homes entered RCT Wave 1 (May 2026)' },
      ]
    },
    {
      labelHtml: 'Remaining controls <span class="count">12</span> <span class="count-drain">\u22125 \u2192 RCT W2</span>',
      thin: true,
      bars: [
        { start: W2_START, end: W3_START, cls: 'bg-ctrl', tip: '12 controls remaining: 5 more homes entered RCT Wave 2 (Sep 2026)' },
      ]
    },
    {
      labelHtml: 'Remaining controls <span class="count">8</span> <span class="count-drain">\u22124 \u2192 RCT W3</span>',
      thin: true,
      bars: [
        { start: W3_START, end: STUDY_END, cls: 'bg-ctrl-post', tip: '8 controls remaining as pure observational controls through Jul 2028. All 14 other homes now in RCT.' },
      ]
    },
  ];
}

const sections = [
  {
    title: '2025 Quasi-Experimental Study \u2014 Intervention Homes (11 clusters)',
    rows: makeIntRows()
  },
  {
    title: '2025 Study \u2014 Control Pool (22 homes \u2192 shrinks as homes enter RCT)',
    rows: makeCtrlRows()
  },
  {
    title: 'RCT Regulatory & Governance',
    rows: [
      { label: 'Protocol finalisation', bars: [{ start: new Date(2026,1,11), end: new Date(2026,1,28), cls: 'bg-reg', tip: 'Final protocol draft: 11\u201328 Feb 2026' }] },
      { label: 'Peer review (2 reviewers)', bars: [{ start: new Date(2026,2,1), end: new Date(2026,2,21), cls: 'bg-peer', tip: 'External peer review: 1\u201321 Mar 2026 (3 weeks)' }] },
      { label: 'Post-review revisions', bars: [{ start: new Date(2026,2,22), end: new Date(2026,3,4), cls: 'bg-reg', tip: 'Incorporate comments: 22 Mar \u2013 4 Apr 2026' }],
        milestones: [{ date: new Date(2026,3,4), tip: 'Protocol locked' }] },
      { label: 'IRAS form preparation', bars: [{ start: new Date(2026,3,5), end: new Date(2026,3,18), cls: 'bg-reg', tip: 'IRAS + docs: 5\u201318 Apr 2026' }],
        milestones: [{ date: new Date(2026,3,18), tip: 'IRAS submitted', cls: 'red' }] },
      { label: 'REC review (60-day clock)', bars: [{ start: new Date(2026,3,18), end: new Date(2026,5,17), cls: 'bg-reg', tip: 'REC: 18 Apr \u2013 17 Jun 2026' }],
        milestones: [{ date: new Date(2026,5,17), tip: 'REC favourable opinion (target)' }] },
      { label: 'CAG s251 (parallel)', bars: [{ start: new Date(2026,3,18), end: new Date(2026,5,26), cls: 'bg-reg', tip: 'CAG: 18 Apr \u2013 26 Jun 2026' }],
        milestones: [{ date: new Date(2026,5,26), tip: 'CAG approval (target)' }] },
      { label: 'ISRCTN registration (parallel)', bars: [{ start: new Date(2026,3,5), end: new Date(2026,4,3), cls: 'bg-reg', tip: 'ISRCTN: 5 Apr \u2013 3 May 2026' }],
        milestones: [{ date: new Date(2026,4,3), tip: 'ISRCTN registered (target)' }] },
      { label: 'HRA confirmation & site setup', bars: [{ start: new Date(2026,5,17), end: new Date(2026,6,10), cls: 'bg-reg', tip: 'HRA + governance: Jun \u2013 Jul 2026' }] },
    ]
  },
  {
    title: 'RCT Wave 1 \u2014 May 2026 (5 pairs \u2192 10 homes)',
    rows: [
      { label: 'W1 Trend window (24 mo)', dataBar: true, bars: [{ start: new Date(2024,2,1), end: new Date(2026,1,28), cls: 'bg-data-trend', tip: 'W1 trend: 1 Mar 2024 \u2013 28 Feb 2026' }] },
      { label: 'W1 Level window (12 mo)', dataBar: true, bars: [{ start: new Date(2025,2,1), end: new Date(2026,1,28), cls: 'bg-data-level', tip: 'W1 level: 1 Mar 2025 \u2013 28 Feb 2026' }] },
      { label: 'W1 Data extraction & pairing', bars: [{ start: new Date(2026,2,1), end: new Date(2026,3,15), cls: 'bg-prep', tip: 'Extract, pair, verify: Mar \u2013 mid Apr 2026' }] },
      { label: 'W1 Randomisation & notification', bars: [{ start: new Date(2026,3,15), end: new Date(2026,4,1), cls: 'bg-prep', tip: 'Randomise, notify: mid Apr \u2013 1 May 2026' }] },
      { labelHtml: 'W1 Intervention arm <span class="count">5 homes</span>', thick: true, bars: [{ start: new Date(2026,4,1), end: STUDY_END, cls: 'bg-rct', tip: 'W1 intervention: 5 homes, May 2026 \u2013 Jul 2028 (26 mo)' }],
        milestones: [{ date: new Date(2026,4,1), tip: 'Wave 1 starts \u2014 5 pairs enter parallel comparison', cls: 'blue' }] },
      { labelHtml: 'W1 Control arm <span class="count">5 homes</span>', thick: true, bars: [{ start: new Date(2026,4,1), end: STUDY_END, cls: 'bg-ctrl', tip: 'W1 control: 5 homes usual care, May 2026 \u2013 Jul 2028 (26 mo)' }] },
    ]
  },
  {
    title: 'RCT Wave 2 \u2014 Sep 2026 (5 pairs \u2192 10 homes)',
    rows: [
      { label: 'W2 Trend window (24 mo)', dataBar: true, bars: [{ start: new Date(2024,6,1), end: new Date(2026,5,30), cls: 'bg-data-trend', tip: 'W2 trend: 1 Jul 2024 \u2013 30 Jun 2026' }] },
      { label: 'W2 Level window (12 mo)', dataBar: true, bars: [{ start: new Date(2025,6,1), end: new Date(2026,5,30), cls: 'bg-data-level', tip: 'W2 level: 1 Jul 2025 \u2013 30 Jun 2026' }] },
      { label: 'W2 Data extraction & re-pairing', bars: [{ start: new Date(2026,6,1), end: new Date(2026,7,15), cls: 'bg-prep', tip: 'Extract updated data, re-pair remaining 18 homes: Jul \u2013 mid Aug 2026' }] },
      { label: 'W2 Randomisation & notification', bars: [{ start: new Date(2026,7,15), end: new Date(2026,8,1), cls: 'bg-prep', tip: 'Randomise from re-formed pairs, notify care homes: mid Aug \u2013 1 Sep 2026' }] },
      { labelHtml: 'W2 Intervention arm <span class="count">5 homes</span>', thick: true, bars: [{ start: new Date(2026,8,1), end: STUDY_END, cls: 'bg-rct', tip: 'W2 intervention: 5 homes, Sep 2026 \u2013 Jul 2028 (22 mo)' }],
        milestones: [{ date: new Date(2026,8,1), tip: 'Wave 2 starts \u2014 20 homes now in parallel comparison', cls: 'blue' }] },
      { labelHtml: 'W2 Control arm <span class="count">5 homes</span>', thick: true, bars: [{ start: new Date(2026,8,1), end: STUDY_END, cls: 'bg-ctrl', tip: 'W2 control: 5 homes usual care, Sep 2026 \u2013 Jul 2028 (22 mo)' }] },
    ]
  },
  {
    title: 'RCT Wave 3 \u2014 Jan 2027 (4 pairs \u2192 8 homes)',
    rows: [
      { label: 'W3 Trend window (24 mo)', dataBar: true, bars: [{ start: new Date(2024,10,1), end: new Date(2026,9,31), cls: 'bg-data-trend', tip: 'W3 trend: 1 Nov 2024 \u2013 31 Oct 2026' }] },
      { label: 'W3 Level window (12 mo)', dataBar: true, bars: [{ start: new Date(2025,10,1), end: new Date(2026,9,31), cls: 'bg-data-level', tip: 'W3 level: 1 Nov 2025 \u2013 31 Oct 2026' }] },
      { label: 'W3 Data extraction & final pairing', bars: [{ start: new Date(2026,10,1), end: new Date(2026,11,15), cls: 'bg-prep', tip: 'Extract updated data, pair final 8 homes: Nov \u2013 mid Dec 2026' }] },
      { label: 'W3 Randomisation & notification', bars: [{ start: new Date(2026,11,15), end: new Date(2027,0,1), cls: 'bg-prep', tip: 'Randomise from final pairs, notify care homes: mid Dec 2026 \u2013 1 Jan 2027' }] },
      { labelHtml: 'W3 Intervention arm <span class="count">4 homes</span>', thick: true, bars: [{ start: new Date(2027,0,1), end: STUDY_END, cls: 'bg-rct', tip: 'W3 intervention: 4 homes, Jan 2027 \u2013 Jul 2028 (18 mo)' }],
        milestones: [{ date: new Date(2027,0,1), tip: 'Wave 3 starts \u2014 all 28 RCT homes enrolled', cls: 'blue' }] },
      { labelHtml: 'W3 Control arm <span class="count">4 homes</span>', thick: true, bars: [{ start: new Date(2027,0,1), end: STUDY_END, cls: 'bg-ctrl', tip: 'W3 control: 4 homes usual care, Jan 2027 \u2013 Jul 2028 (18 mo)' }] },
    ]
  },
  {
    title: 'Analysis',
    rows: [
      { label: 'Earliest primary analysis', bars: [{ start: new Date(2028,6,1), end: new Date(2028,8,30), cls: 'bg-obs', tip: 'Primary analysis: Jul \u2013 Sep 2028' }],
        milestones: [{ date: new Date(2028,6,1), tip: 'Primary analysis: \u2265 Jul 2028 (18 mo after W3)', cls: 'red' }] },
    ]
  },
];

// ── Render ─────────────────────────────────────────────────────────────

const chart = document.getElementById('chart');
const tooltip = document.getElementById('tooltip');

const stickyWrap = document.createElement('div');
stickyWrap.className = 'sticky-header';

const yearDiv = document.createElement('div');
yearDiv.className = 'year-label';
for (let y = 2024; y <= 2028; y++) {
  const s = y === 2024 ? TIMELINE_START : new Date(y,0,1);
  const e = new Date(y+1,0,1) > TIMELINE_END ? TIMELINE_END : new Date(y+1,0,1);
  const span = document.createElement('div');
  span.className = 'year-span';
  span.style.width = (pct(e) - pct(s)) + '%';
  span.textContent = y;
  yearDiv.appendChild(span);
}

const monthDiv = document.createElement('div');
monthDiv.className = 'month-header';
const mN = ['J','F','M','A','M','J','J','A','S','O','N','D'];
let d = new Date(2024, TIMELINE_START.getMonth(), 1);
while (d < TIMELINE_END) {
  const cell = document.createElement('div');
  cell.className = 'month-cell' + (d.getMonth()===0 ? ' year-start' : '');
  cell.textContent = mN[d.getMonth()];
  monthDiv.appendChild(cell);
  d = new Date(d.getFullYear(), d.getMonth()+1, 1);
}

// Legend inside sticky header
const legendBar = document.createElement('div');
legendBar.className = 'legend-bar';
const legendItems = [
  ['var(--accent-pre)', 'Pre-intervention'],
  ['var(--accent-2025)', '2025 intervention (analysed)'],
  ['var(--accent-nodata)', 'Data not analysed'],
  ['var(--accent-ctrl)', 'Control / usual care'],
  ['var(--accent-reg)', 'Regulatory'],
  ['var(--accent-peer)', 'Peer review'],
  ['var(--accent-prep)', 'Preparation'],
  ['var(--accent-rct)', 'RCT intervention arm'],
  ['var(--accent-data-trend)', 'Trend window'],
  ['var(--accent-data-level)', 'Level window'],
  ['var(--accent-obs)', 'Analysis'],
];
legendItems.forEach(([color, label]) => {
  const item = document.createElement('div');
  item.className = 'legend-item';
  const swatch = document.createElement('div');
  swatch.className = 'legend-swatch';
  swatch.style.background = color;
  item.appendChild(swatch);
  item.appendChild(document.createTextNode(label));
  legendBar.appendChild(item);
});
const mItem = document.createElement('div');
mItem.className = 'legend-item';
const mSwatch = document.createElement('div');
mSwatch.className = 'legend-swatch';
mSwatch.style.cssText = 'background:var(--milestone); width:9px; height:9px; transform:rotate(45deg); border-radius:0;';
mItem.appendChild(mSwatch);
mItem.appendChild(document.createTextNode('Milestone'));
legendBar.appendChild(mItem);

stickyWrap.appendChild(legendBar);
stickyWrap.appendChild(yearDiv);
stickyWrap.appendChild(monthDiv);
chart.appendChild(stickyWrap);

sections.forEach(sec => {
  const lbl = document.createElement('div');
  lbl.className = 'section-label';
  lbl.textContent = sec.title;
  chart.appendChild(lbl);

  sec.rows.forEach(r => {
    const row = document.createElement('div');
    row.className = 'row' + (r.thin ? ' row-thin' : '') + (r.thick ? ' row-thick' : '') + ((!r.thin && !r.thick) ? ' row-std' : '');
    const rl = document.createElement('div');
    rl.className = 'row-label';
    if (r.labelHtml) rl.innerHTML = r.labelHtml;
    else rl.textContent = r.label;
    row.appendChild(rl);

    const track = document.createElement('div');
    track.className = 'row-track';

    if (r.dashed) {
      const dl = document.createElement('div');
      dl.className = 'bar-dashed-leader' + (r.dashedCls ? ' ' + r.dashedCls : '');
      dl.style.left = '0%'; dl.style.width = LEADER_W + '%';
      if (r.dashedTip) dl.dataset.tip = r.dashedTip;
      track.appendChild(dl);
      const arr = document.createElement('div');
      arr.className = 'pre-arrow ' + (r.dashedArrowCls || '');
      arr.style.left = '0.15%'; arr.innerHTML = '\u25C0';
      if (r.dashedTip) arr.dataset.tip = r.dashedTip;
      track.appendChild(arr);
    }

    (r.bars || []).forEach(b => {
      const barCls = r.thin ? 'bar-thin' : (r.thick ? 'bar-thick' : 'bar');
      const finalCls = r.dataBar ? 'bar-data' : barCls;
      const bar = document.createElement('div');
      bar.className = finalCls + ' ' + b.cls;
      let l = pct(b.start); let w = pct(b.end) - l;
      if (b.dashedJoin) { l = LEADER_W; w = pct(b.end) - LEADER_W; bar.style.borderRadius = '0 2px 2px 0'; }
      bar.style.left = l + '%'; bar.style.width = Math.max(0.2, w) + '%';
      if (r.dataBar) bar.style.top = '8px';
      bar.dataset.tip = b.tip;
      track.appendChild(bar);
    });

    if (r.goLiveTick) {
      const tick = document.createElement('div');
      tick.className = 'go-live-tick';
      tick.style.left = pct(r.goLiveTick) + '%';
      track.appendChild(tick);
    }

    (r.milestones || []).forEach(m => {
      const dia = document.createElement('div');
      dia.className = 'milestone-diamond' + (m.cls ? ' ' + m.cls : '');
      dia.style.left = 'calc(' + pct(m.date) + '% - 4.5px)';
      dia.dataset.tip = m.tip;
      track.appendChild(dia);
    });

    row.appendChild(track);
    chart.appendChild(row);
  });
});

const tp = pct(TODAY);
if (tp >= 0 && tp <= 100) {
  chart.querySelectorAll('.row-track').forEach(t => {
    const line = document.createElement('div');
    line.className = 'today-line'; line.style.left = tp + '%';
    t.appendChild(line);
  });
  const ft = chart.querySelector('.row-track');
  if (ft) {
    const flag = document.createElement('div');
    flag.className = 'today-flag'; flag.style.left = tp + '%'; flag.style.top = '-18px';
    flag.textContent = '\u25BC TODAY'; ft.appendChild(flag);
  }
}

document.addEventListener('mousemove', e => {
  const el = e.target.closest('[data-tip]');
  if (el) {
    tooltip.style.display = 'block'; tooltip.textContent = el.dataset.tip;
    tooltip.style.left = Math.min(e.clientX + 12, window.innerWidth - 380) + 'px';
    tooltip.style.top = (e.clientY - 36) + 'px';
  } else { tooltip.style.display = 'none'; }
});
</script>

</body>
</html>
